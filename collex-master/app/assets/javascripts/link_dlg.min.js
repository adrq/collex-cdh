var CacheObjects=Class.create({initialize:function(){var e=new Hash;this.get=function(n){return e.get(n)},this.reset=function(n){e.set(n,null)},this.set=function(n,l){e.set(n,l)},this.resetAll=function(){e=new Hash}}}),ninesObjCache=new CacheObjects,CreateListOfObjects=Class.create({initialize:function(e,n,l,t,i){var s="linkdlg_item_selected",a=$(l),d=null,r=null,o=this;this.getSelection=function(){var e=a.down("."+s);if(!e)return{field:null,value:null};var n=e.id.substring(e.id.indexOf("_")+1);return{field:l,value:n}},this.clearSelection=function(){var e=a.down("."+s);e&&e.removeClassName(s)};var c,u,g;this.useTabs=function(e,n){c=e,g=u=n},this.ninesObjView=function(e,n){var l;if(l="all"===n.arg0?c:u,l!==g){o.repopulate(n.dlg,l),g=l;var t=n.dlg.getOuterDomElement(),i=t.select(".dlg_tab_link"),s=t.select(".dlg_tab_link_current");i[0].addClassName("dlg_tab_link_current"),i[0].removeClassName("dlg_tab_link"),s[0].addClassName("dlg_tab_link"),s[0].removeClassName("dlg_tab_link_current")}},this.resetCacheIfNecessary=function(){g!==u&&ninesObjCache.reset(u)};var _=function(e,n,d,r,o){var c=new Element("div",{id:e});c.addClassName("linkdlg_item");var u=new Element("div");u.addClassName("linkdlg_img_wrapper");var g,_;n&&n.length>0&&(g=new Element("img",{src:t,alt:d,title:d}),g.addClassName("linkdlg_img"),_=new Element("img",{id:e+"_img",src:n,alt:d,title:d}),_.addClassName("linkdlg_img"),_.addClassName("hidden"));var h=new Element("div");h.addClassName("linkdlg_text");var f=new Element("div").update(r);f.addClassName("linkdlg_firstline");var p=new Element("div",{id:e+"_img"}).update(o);p.addClassName("linkdlg_secondline");var v=new Element("hr");v.addClassName("clear_both"),v.addClassName("linkdlg_hr"),h.appendChild(f),h.appendChild(p),n&&n.length>0&&(u.appendChild(g),u.appendChild(_)),c.appendChild(u),c.appendChild(h),c.appendChild(v),a.appendChild(c);var b=function(){var e=$(this);e.previous().addClassName("hidden");var n=parseInt(e.getStyle("height"));e.removeClassName("linkdlg_img");var l=e.height,t=e.width;if(0===l&&0===t)e.height=n,e.width=n;else if(l>=t)e.height=n;else{e.width=n;var i=n*l/t,s=parseInt((n-i)/2);e.style.paddingTop=s+"px"}e.removeClassName("hidden")};YAHOO.util.Event.addListener(e+"_img","load",b);var k=function(){$(l).select("."+s).each(function(e){e.removeClassName(s)}),$(this.id).addClassName(s),i&&i(this.id)};YAHOO.util.Event.addListener(e,"click",k)},h=function(e,l,t){if(a.innerHTML="",e.each(function(e){_(t+"_"+e.id,e.img,e.title,e.strFirstLine,e.strSecondLine)}),r=new Element("div",{id:"noObjMsg"}).update("<< No objects >>"),r.addClassName("empty_list_text"),a.appendChild(r),0!==e.length&&r.hide(),n){var i=$(t+"_"+n);if(i)i.addClassName(s),YAHOO.util.Event.onAvailable(i.id,function(){var e=i.offsetTop,n=a.offsetTop,l=e-n,t=parseInt(i.getStyle("height"))/2,s=parseInt(a.getStyle("height"));l+t>s&&(a.scrollTop=l+t-s/2)});else{var d=a.down();d&&"noObjMsg"!==d.id&&d.addClassName(s)}}else if(l){var o=a.down();o&&"noObjMsg"!==o.id&&o.addClassName(s)}},f=function(){var e=$(a).select(".linkdlg_item");e.each(function(e){e.remove()}),r.parent&&r.remove()},p=e;this.repopulate=function(e,n){p=n,f(),this.populate(e,!1,d)},this.populate=function(e,n,l){var t=ninesObjCache.get(p);if(d=l,e.setFlash("",!1),t)h(t,n,d);else{e.setFlash("Getting objects...",!1);var i=function(l){e.setFlash("",!1);try{l.responseText.length>0&&(t=l.responseText.evalJSON(!0),ninesObjCache.set(p,t),h(t,n,d))}catch(i){new MessageBoxDlg("Error",i)}};serverRequest({url:p,onSuccess:i})}},this.add=function(e){a.appendChild(e),a.down("#noObjMsg").hide()},this.popSelection=function(){var e=a.down("."+s);return e&&(e.removeClassName(s),e.remove()),1===a.childNodes.length&&a.down("#noObjMsg").show(),ninesObjCache.resetAll(),e},this.getAllObjects=function(){var e=[],n=a.select(".linkdlg_item");return n.each(function(n){var l=n.readAttribute("id");l=l.substring(l.indexOf("_")+1),e.push(l)}),e},this.getMarkup=function(){if(!a){a=new Element("div",{id:l});var e=new Element("img",{src:t});e.addClassName("link_dlg_object_progress"),a.appendChild(e);var n=new Element("div");$(n).setStyle({padding:"8px","text-align":"center"}),n.innerHTML="Please wait while your collected objects are being loaded",a.appendChild(n)}return a.addClassName("linkdlg_list"),a};var v="",b=function(){var e=$(a).select(".linkdlg_item"),n=!1;e.each(function(e){var l=e.innerHTML;l=l.stripTags(),v.blank()||l.toLowerCase().indexOf(v)>=0?(e.show(),n=!0):e.hide()}),n?r.hide():r.show()};this.filter=function(e){v=e.toLowerCase(),b()},this.sortby=function(n,l){var t=ninesObjCache.get(e);"date_collected"!==l&&(t=t.sortBy(function(e){return"title"===l?0===e.strFirstLine.length?"ZZZZZZ":e.strFirstLine.toUpperCase().gsub(/[^A-Z]/,""):0===e.strSecondLine.length?"ZZZZZZ":e.strSecondLine.toUpperCase().gsub(/[^A-Z]/,"")})),f(),h(t,!0,d),b()}}}),LinkDlgHandler=Class.create({initialize:function(e,n){var l=null,t=null,i=null,s=null;this.getPopulateUrls=function(){return e};var a=function(e,n){for(var l=function(e,n,l,t){var i=e.substring(n).indexOf(l),s=e.substring(n).indexOf(t);return i>=0&&(-1===s||s>i)?{found:l,index:n+i}:s>=0?{found:t,index:n+s}:{found:""}},t=function(e,n,l,t){var i=e.substring(0,n).lastIndexOf(l),s=e.substring(0,n).lastIndexOf(t);return i>=0&&i>s?{found:l,index:i}:s>=0?{found:t,index:s}:{found:""}},i=!1,s=n;!i;){var a=t(e,s,"</span>","real_link");if("</span>"===a.found)s=e.substring(0,a.index).lastIndexOf("<span");else{if("real_link"!==a.found)return null;s=e.substring(0,a.index).lastIndexOf("<span"),i=!0}}i=!1;for(var d=n;!i;){var r=l(e,d,"</span>","<span");if("</span>"===r.found)d=r.index+7,i=!0;else{if("<span"!==r.found)return null;d=e.substring(r.index).lastIndexOf("</span>")}}return[s,d]},d=function(a,d){var r=["Collected Object","External Link"],o=function(e,n){var l=n===r[0]?".ld_link_only":".ld_nines_only",t=n!==r[0]?".ld_link_only":".ld_nines_only";$$(l).each(function(e){e.addClassName("hidden")}),$$(t).each(function(e){e.removeClassName("hidden")})},c=function(e){for(var n=e,l=n.indexOf("real_link");l>0;){var t=n.substring(0,l).lastIndexOf("<span"),i=n.substring(l).indexOf(">"),s=n.substring(l).indexOf("</span>");if(0>t||0>i||0>s)return e;n=n.substring(0,t)+n.substring(l+i+1,l+s)+n.substring(l+s+7),l=n.indexOf("real_link")}return n},u=function(){return{prologue:s.substring(0,t),selection:s.substring(t,i),ending:s.substring(i)}},g=function(e,n){var t=u();t.selection=c(t.selection),l.updateContents(t.prologue+t.selection+t.ending),n.dlg.cancel()},_=function(e,n){var t=n.dlg,i=t.getAllData(),s=u();s.selection=c(s.selection),"Collected Object"===i.ld_type?i.ld_nines_object&&(s.selection='<span title="'+r[0]+": "+i.ld_nines_object+'" real_link="'+i.ld_nines_object+'" class="nines_linklike">'+s.selection+"</span>",l.updateContents(s.prologue+s.selection+s.ending)):(s.selection='<span title="'+r[1]+": "+i.ld_link_url+'" real_link="'+i.ld_link_url+'" class="ext_linklike">'+s.selection+"</span>",l.updateContents(s.prologue+s.selection+s.ending)),n.dlg.cancel()},h=new CreateListOfObjects(e[0],0===a?d:null,"ld_nines_object",n);2===e.length&&h.useTabs(e[1],e[0]);var f={page:"layout",rows:[[{text:"Type of Link:",klass:"link_dlg_label"},{select:"ld_type",callback:o,klass:"link_dlg_select",value:r[a],options:[{text:"Collected Object",value:"Collected Object"},{text:"External Link",value:"External Link"}]}],[{text:"Sort objects by:",klass:"link_dlg_label ld_nines_only hidden"},{select:"sort_by",callback:h.sortby,klass:"link_dlg_select ld_nines_only hidden",value:"date_collected",options:[{text:"Date Collected",value:"date_collected"},{text:"Title",value:"title"},{text:"Author",value:"author"}]},{text:"and",klass:"link_dlg_label_and ld_nines_only hidden"},{inputFilter:"filterObjectsLnk",prompt:"type to filter objects",callback:h.filter,klass:"ld_nines_only hidden"}],[{link:"[Remove Link]",callback:g,klass:"remove nav_link hidden"}],[{custom:h,klass:"link_dlg_label ld_nines_only hidden"},{text:"Link URL",klass:"link_dlg_label ld_link_only hidden"},{input:"ld_link_url",value:1===a?d:"",klass:"link_dlg_input_long ld_link_only hidden"}],[{rowClass:"gd_last_row"},{button:"Save",callback:_,isDefault:!0},{button:"Cancel",callback:GeneralDialog.cancelCallback}]]};2===e.length&&(f.rows[2].push({link:"Exhibit Palette",klass:"dlg_tab_link_current ld_nines_only hidden",callback:h.ninesObjView,arg0:"exhibit"}),f.rows[2].push({link:"All My Objects",klass:"dlg_tab_link ld_nines_only hidden",callback:h.ninesObjView,arg0:"all"}));var p={this_id:"link_dlg",pages:[f],body_style:"link_dlg",row_style:"link_dlg_row",title:"Set Link",focus:"link_dlg_sel0"},v=new GeneralDialog(p);h.populate(v,!0,"rte"),d.length>0&&$$(".remove").each(function(e){e.removeClassName("hidden")}),o(null,r[a]),v.center()};this.show=function(e,n,r,o){l=e,t=r,i=o,s=n;var c=function(e){var n=e.indexOf("real_link");if(0>n)return null;var l=e.substring(n+11).indexOf('"');return e.substring(n+11,n+11+l)},u="",g=0,_=a(s,t);if(_){t=_[0],i=_[1];var h=s.substring(t,i);h.indexOf("ext_linklike")>0&&(g=1);var f=h.indexOf("real_link")+11,p=h.substring(f).indexOf('"');u=h.substring(f,f+p)}else _=c(s.substring(t,i)),_&&(u=_);d(g,u)}}});