jQuery(document).ready(function(e){"use strict";function r(e){var r=window.collex.getUrlVars();if(e.doScript=window.collex.getUrlScriptVars(),e.doScript.hasOwnProperty("script")){var n=e.doScript.script;"doCollect"===n?doCollect("/results/result_row",e.doScript.uri,e.doScript.row_num,e.doScript.row_id,!0):"doTypewright"===n?gotoPage(e.doScript.uri):console.error('Unknown doScript action: "'+n+'"');var t="./search?"+window.collex.makeQueryString(r);w(t,!0)}e.query=r;for(var a in e.query)e.query.hasOwnProperty(a)&&(e.query[a]&&0!==e.query[a].length||delete e.query[a]);v.trigger("RedrawSearchResults",e),window.cancelProgressDialog()}function n(e){window.cancelProgressDialog(),window.console.error(e)}function t(){window.showProgressDialog("Searching...");var t=window.collex.getUrlVars();e.ajax({url:"./search.json",data:t,success:r,error:n})}function a(r,n){var t=window.collex.getUrlVars();return void 0===t[r]?t[r]=n:"string"==typeof t[r]?t[r]=[t[r],n]:-1===e.inArray(n,t[r])&&t[r].push(n),t}function o(r,n){var t=window.collex.getUrlVars();if(void 0===t[r])return t;if("string"==typeof t[r])t[r]===n&&delete t[r];else{var a=e.inArray(n,t[r]);-1!==a&&t[r].splice(a,1)}return t}function i(r,n,t){var a=window.collex.getUrlVars();if(void 0===a[r])return a;if("string"==typeof a[r])a[r]===n&&(a[r]=t);else{var o=e.inArray(n,a[r]);-1!==o&&(a[r][o]=t)}return a}function l(){var e=window.collex.getUrlVars(),r={};return e.srt&&(r.srt=e.srt),e.dir&&(r.dir=e.dir),e.f&&(r.f=e.f),r}function c(e,r){var n=window.collex.getUrlVars();return n[e]=r,n}function s(e,r,n){var t;return"remove"===n?(t=o(e,r),"origin"==e?(window.collex.generalFacets("Origin"),window.collex.generalFacets("Origin")):"provenance"==e?(window.collex.generalFacets("Provenance"),window.collex.generalFacets("Provenance")):"composition"==e?(window.collex.generalFacets("Composition"),window.collex.generalFacets("Composition")):"type_digital_artifact"==e?(window.collex.generalFacets("type_digital_artifact"),window.collex.generalFacets("type_digital_artifact")):"type_original_artifact"==e?(window.collex.generalFacets("type_original_artifact"),window.collex.generalFacets("type_original_artifact")):"g"==e?(window.collex.generalFacets("Genre"),window.collex.generalFacets("Genre")):"lang"==e?(window.collex.generalFacets("Language"),window.collex.generalFacets("Language")):(window.collex.generalFacets("Access"),window.collex.generalFacets("Access"))):"add"===n?(t=a(e,r),"origin"==e?(window.collex.generalFacets("Origin"),window.collex.generalFacets("Origin")):"provenance"==e?(window.collex.generalFacets("Provenance"),window.collex.generalFacets("Provenance")):"composition"==e?(window.collex.generalFacets("Composition"),window.collex.generalFacets("Composition")):"type_digital_artifact"==e?(window.collex.generalFacets("type_digital_artifact"),window.collex.generalFacets("type_digital_artifact")):"type_original_artifact"==e?(window.collex.generalFacets("type_original_artifact"),window.collex.generalFacets("type_original_artifact")):"g"==e?(window.collex.generalFacets("Genre"),window.collex.generalFacets("Genre")):"lang"==e?(window.collex.generalFacets("Language"),window.collex.generalFacets("Language")):(window.collex.generalFacets("Access"),window.collex.generalFacets("Access"))):t=c(e,r),"page"!==e&&delete t.page,"./search?"+window.collex.makeQueryString(t)}function d(){return!(!window.history||!history.pushState)}function w(e,r){var n="./search"+window.location.search;if(e!==n)if(window.collex.resetNameFacet(),d()){var t=document.title;r===!0?History.replaceState(null,t,e):History.pushState(null,t,e)}else window.location=e}function u(e){var r=e.closest("tr"),n=r.find(".query_type_select").val(),t=r.find(".query_term input").val();"y"===n&&(t=window.collex.formatYearString(t)),t=window.collex.sanitizeString(t),"lang"===n&&(t=r.find(".query_term select").val());var a=r.find(".new-query_and-not select").val();"NOT"===a&&t&&"-"!==t[0]&&(t="-"+t);var o=s(n,t,"add");w(o)}function g(){var r=window.collex.getUrlVars(),n=e(".sort select[name='dir']");r.srt&&r.srt.length>0?(e(".sort select[name='srt']").val(r.srt),r.dir&&r.dir.length>0&&n.val(r.dir)):n.hide()}function f(){window.collex&&("search"===window.collex.pageName?(g(),console.log("initializeSearch() showing progress"),t()):window.collex.hits&&window.collex.hits.length>0&&setTimeout(function(){v.trigger("DrawHits",{hits:window.collex.hits,collected:window.collex.collected}),window.collex.drawSavedSearchList()},10))}var v=e("body");e("#search_submit").on("click",function(r){r.preventDefault();var n=e(".limit_to_federation input"),t=[];n.each(function(e,r){r.checked&&t.push(r.name)});var a=window.collex.getUrlVars();0==t.length?delete a.f:a.f=t,delete a.page;var o="./search?"+window.collex.makeQueryString(a);e("#add-search-constraint").attr("action",o).submit()});var p,h;e(function(){e("#slider-range").slider({range:!0,min:0,max:2e3,values:[0,0],slide:function(r,n){e("#amount").val(n.values[0]+" - "+n.values[1]),p=n.values[0],h=n.values[1]}}),e("#amount").val(e("#slider-range").slider("values",0)+" - "+e("#slider-range").slider("values",1))}),window.collex.Range=function(){window.collex.sliderRange(p,h)},window.collex.getUrlVars=function(e){var r={},n=""+window.location.search;if(""===n)return r;n=n.substr(1);for(var t=n.split("&"),a=0;a<t.length;a++){var o;o=t[a].split("=");var i=o[0];if(e!==!0&&"script"===i)break;1===o.length&&o.push("");var l=decodeURIComponent(o[1]);void 0!==r[i]?"string"==typeof r[i]?r[i]=[r[i],l]:r[i].push(l):r[i]=l}return r},window.collex.getUrlScriptVars=function(){var e={},r=""+window.location.search;if(""===r)return e;r=r.substr(1);for(var n=r.split("&"),t=!1,a=0;a<n.length;a++){var o;o=n[a].split("=");var i=o[0];if(1==t||"script"===i){1===o.length&&o.push(""),t=!0;var l=decodeURIComponent(o[1]);void 0!==e[i]?"string"==typeof e[i]?e[i]=[e[i],l]:e[i].push(l):e[i]=l}}return e},window.collex.makeQueryString=function(e){var r=[];for(var n in e)if(e.hasOwnProperty(n)){var t=e[n];if("undefined"!=typeof t)if("string"==typeof t)r.push(n+"="+t);else for(var a=0;a<t.length;a++)r.push(n+"="+t[a])}return r.join("&")},History.Adapter.bind(window,"statechange",function(){History.getState(),t()}),window.collex.removeSortFromQueryObject=function(){var e=window.collex.getUrlVars();return delete e.srt,delete e.dir,e},window.collex.removeSortAndPageFromQueryObject=function(){var e=window.collex.removeSortFromQueryObject();return delete e.page,e},v.on("click",".new_search",function(){var r=l();e("#slider-range").slider({range:!0,min:0,max:2e3,values:[0,0],slide:function(r,n){e("#amount").val(n.values[0]+" - "+n.values[1]),p=n.values[0],h=n.values[1]}}),e("#amount").val(e("#slider-range").slider("values",0)+" - "+e("#slider-range").slider("values",1)),w("./search?"+window.collex.makeQueryString(r))}),v.on("click",".ajax-style .select-facet",function(){var r=e(this),n=r.attr("data-key"),t=r.attr("data-value"),a=r.attr("data-action"),o=s(n,t,a);return w(o),!1}),v.on("change",".ajax-style .sort select",function(){var r,n=e(this),t=n.attr("name"),a=n.val();if("srt"===t)if("rel"===a){e(".sort select[name='dir']").hide();var o=window.collex.removeSortFromQueryObject();r="./search?"+window.collex.makeQueryString(o)}else e(".sort select[name='dir']").show();r||(r=s(t,a,"replace")),w(r)}),window.collex.sanitizeString=function(r){if("undefined"==typeof r)return r;for(r=r.replace(/[^0-9A-Za-z\-'"\u00C0-\u017F]/g," ");"'"===r.substr(0,1);)r=r.substr(1);return r=r.replace(/ '/g," "),r=r.replace(/\s+/g," "),e.trim(r)},window.collex.formatYearString=function(e){return e=e.trim().replace(/-/," TO ").replace(/to/i,"TO").replace(/\s+/," "),e=e.replace(/(\b\d{3})\b/g,"0$1"),e=e.replace(/(\b\d{2})\b/g,"00$1"),e=e.replace(/(\b\d{1})\b/g,"000$1"),e=e.trim()},window.collex.sliderRange=function(e,r){var n="y="+e+" TO "+r+"&fuz_q=1&fuz_t=1";n=window.collex.formatYearString(n),w("./search?"+n),t()},v.on("click",".query_add",function(){u(e(this))}),v.on("click",".mod-fuzzy input",function(){var r=e(this),n=this.name,t=r.val(),a=s(n,t,"replace");w(a)}),v.on("change",".query_and-not select",function(){var r=e(this),n=r.val(),t=r.attr("data-key"),a=r.attr("data-val"),o=a;"AND"===n&&"-"===o[0]&&(o=o.substr(1)),"NOT"===n&&"-"!==o[0]&&(o="-"+o);var l=i(t,a,o);w("./search?"+window.collex.makeQueryString(l))}),v.on("keydown",".query.search-form .new-search-term input",function(e){var r=e.which;return 13===r||10===r?!1:void 0}),v.on("keyup",".query.search-form .new-search-term input",function(r){var n=r.which;return 13===n||10===n?(u(e(this)),!1):void 0}),v.on("change",".search_all_federations",function(){if(this.checked){for(var r=[],n=e(".limit_to_federation input"),t=0;t<n.length;t++)r.push(n[t].name);var a=s("f",r,"replace");w(a)}else{var o=window.collex.getUrlVars();delete o.f,delete o.page,w("./search?"+window.collex.makeQueryString(o)),e(".limit_to_federation input").each(function(){e(this).prop("checked",!1)})}}),window.collex.doPageSearch=function(e){var r=window.collex.getUrlVars();r.pages=e,w("./search?"+window.collex.makeQueryString(r))},v.on("change",".limit_to_federation input",function(){var r=e(".limit_to_federation input"),n=!0,t=[];r.each(function(e,r){r.checked&&(n=!1,t.push(r.name))}),t.length<r.length&&e(".search_all_federations").prop("checked",!1);var a=window.collex.getUrlVars();n?delete a.f:a.f=t,delete a.page,w("./search?"+window.collex.makeQueryString(a))}),v.bind("SetSearch",function(e,r){for(var n in r)r.hasOwnProperty(n)&&(r[n]=window.collex.sanitizeString(r[n]));var t=l();jQuery.extend(r,t),w("./search?"+window.collex.makeQueryString(r))}),v.bind("ModifySearch",function(e,r){"y"===r.key&&(r.newValue=window.collex.formatYearString(r.newValue));var n=i(r.key,r.original,window.collex.sanitizeString(r.newValue));w("./search?"+window.collex.makeQueryString(n))}),f()});