jQuery(document).ready(function(e){"use strict";function r(e){var r=window.collex.getUrlVars();if(e.doScript=window.collex.getUrlScriptVars(),e.doScript.hasOwnProperty("script")){var n=e.doScript.script;"doCollect"===n?doCollect("/results/result_row",e.doScript.uri,e.doScript.row_num,e.doScript.row_id,!0):"doTypewright"===n?gotoPage(e.doScript.uri):console.error('Unknown doScript action: "'+n+'"');var t="./search?"+window.collex.makeQueryString(r);w(t,!0)}e.query=r;for(var o in e.query)e.query.hasOwnProperty(o)&&(e.query[o]&&0!==e.query[o].length||delete e.query[o]);p.trigger("RedrawSearchResults",e),window.cancelProgressDialog()}function n(e){window.cancelProgressDialog(),window.console.error(e)}function t(){window.showProgressDialog("Searching...");var t=window.collex.getUrlVars();e.ajax({url:"./search.json",data:t,success:r,error:n})}function o(r,n){var t=window.collex.getUrlVars();return void 0===t[r]?t[r]=n:"string"==typeof t[r]?t[r]=[t[r],n]:-1===e.inArray(n,t[r])&&t[r].push(n),t}function a(r,n){var t=window.collex.getUrlVars();if(void 0===t[r])return t;if("string"==typeof t[r])t[r]===n&&delete t[r];else{var o=e.inArray(n,t[r]);-1!==o&&t[r].splice(o,1)}return t}function i(r,n,t){var o=window.collex.getUrlVars();if(void 0===o[r])return o;if("string"==typeof o[r])o[r]===n&&(o[r]=t);else{var a=e.inArray(n,o[r]);-1!==a&&(o[r][a]=t)}return o}function l(){var e=window.collex.getUrlVars(),r={};return e.srt&&(r.srt=e.srt),e.dir&&(r.dir=e.dir),e.f&&(r.f=e.f),r}function c(e,r){var n=window.collex.getUrlVars();return n[e]=r,n}function s(e,r,n){var t;return"remove"===n?(t=a(e,r),"origin"==e?(window.collex.generalFacets("Origin"),window.collex.generalFacets("Origin")):"provenance"==e?(window.collex.generalFacets("Provenance"),window.collex.generalFacets("Provenance")):"composition"==e?(window.collex.generalFacets("Composition"),window.collex.generalFacets("Composition")):"type_digital_artifact"==e?(window.collex.generalFacets("type_digital_artifact"),window.collex.generalFacets("type_digital_artifact")):"type_original_artifact"==e?(window.collex.generalFacets("type_original_artifact"),window.collex.generalFacets("type_original_artifact")):"g"==e?(window.collex.generalFacets("Genre"),window.collex.generalFacets("Genre")):"lang"==e?(window.collex.generalFacets("Language"),window.collex.generalFacets("Language")):(window.collex.generalFacets("Access"),window.collex.generalFacets("Access"))):"add"===n?(t=o(e,r),"origin"==e?(window.collex.generalFacets("Origin"),window.collex.generalFacets("Origin")):"provenance"==e?(window.collex.generalFacets("Provenance"),window.collex.generalFacets("Provenance")):"composition"==e?(window.collex.generalFacets("Composition"),window.collex.generalFacets("Composition")):"type_digital_artifact"==e?(window.collex.generalFacets("type_digital_artifact"),window.collex.generalFacets("type_digital_artifact")):"type_original_artifact"==e?(window.collex.generalFacets("type_original_artifact"),window.collex.generalFacets("type_original_artifact")):"g"==e?(window.collex.generalFacets("Genre"),window.collex.generalFacets("Genre")):"lang"==e?(window.collex.generalFacets("Language"),window.collex.generalFacets("Language")):(window.collex.generalFacets("Access"),window.collex.generalFacets("Access"))):t=c(e,r),"page"!==e&&delete t.page,"./search?"+window.collex.makeQueryString(t)}function d(){return!(!window.history||!history.pushState)}function w(e,r){var n="./search"+window.location.search;if(e!==n)if(window.collex.resetNameFacet(),d()){var t=document.title;r===!0?History.replaceState(null,t,e):History.pushState(null,t,e)}else window.location=e}function u(e){var r=e.closest("tr"),n=r.find(".query_type_select").val(),t=r.find(".query_term input").val();"y"===n&&(t=window.collex.formatYearString(t)),t=window.collex.sanitizeString(t),"lang"===n&&(t=r.find(".query_term select").val());var o=r.find(".new-query_and-not select").val();"NOT"===o&&t&&"-"!==t[0]&&(t="-"+t);var a=s(n,t,"add");w(a)}function g(){var r=window.collex.getUrlVars(),n=e(".sort select[name='dir']");r.srt&&r.srt.length>0?(e(".sort select[name='srt']").val(r.srt),r.dir&&r.dir.length>0&&n.val(r.dir)):n.hide()}function f(){window.collex&&("search"===window.collex.pageName?(g(),console.log("initializeSearch() showing progress"),t()):window.collex.hits&&window.collex.hits.length>0&&setTimeout(function(){p.trigger("DrawHits",{hits:window.collex.hits,collected:window.collex.collected}),window.collex.drawSavedSearchList()},10))}var p=e("body");e("#search_submit").on("click",function(r){r.preventDefault();var n=e(".limit_to_federation input"),t=[];n.each(function(e,r){r.checked&&t.push(r.name)});var o=window.collex.getUrlVars();0==t.length?delete o.f:o.f=t,delete o.page;var a="./search?"+window.collex.makeQueryString(o);e("#add-search-constraint").attr("action",a).submit()});var h,v;e(function(){e("#slider-range").slider({range:!0,min:0,max:2e3,values:[100,800],slide:function(r,n){e("#amount").val(n.values[0]+" - "+n.values[1]),h=n.values[0],v=n.values[1]}}),e("#amount").val(e("#slider-range").slider("values",0)+" - "+e("#slider-range").slider("values",1))}),window.collex.Range=function(){window.collex.sliderRange(h,v)},window.collex.getUrlVars=function(e){var r={},n=""+window.location.search;if(""===n)return r;n=n.substr(1);for(var t=n.split("&"),o=0;o<t.length;o++){var a;a=t[o].split("=");var i=a[0];if(e!==!0&&"script"===i)break;1===a.length&&a.push("");var l=decodeURIComponent(a[1]);void 0!==r[i]?"string"==typeof r[i]?r[i]=[r[i],l]:r[i].push(l):r[i]=l}return r},window.collex.getUrlScriptVars=function(){var e={},r=""+window.location.search;if(""===r)return e;r=r.substr(1);for(var n=r.split("&"),t=!1,o=0;o<n.length;o++){var a;a=n[o].split("=");var i=a[0];if(1==t||"script"===i){1===a.length&&a.push(""),t=!0;var l=decodeURIComponent(a[1]);void 0!==e[i]?"string"==typeof e[i]?e[i]=[e[i],l]:e[i].push(l):e[i]=l}}return e},window.collex.makeQueryString=function(e){var r=[];for(var n in e)if(e.hasOwnProperty(n)){var t=e[n];if("undefined"!=typeof t)if("string"==typeof t)r.push(n+"="+t);else for(var o=0;o<t.length;o++)r.push(n+"="+t[o])}return r.join("&")},History.Adapter.bind(window,"statechange",function(){History.getState(),t()}),window.collex.removeSortFromQueryObject=function(){var e=window.collex.getUrlVars();return delete e.srt,delete e.dir,e},window.collex.removeSortAndPageFromQueryObject=function(){var e=window.collex.removeSortFromQueryObject();return delete e.page,e},p.on("click",".new_search",function(){var e=l();w("./search?"+window.collex.makeQueryString(e))}),p.on("click",".ajax-style .select-facet",function(){var r=e(this),n=r.attr("data-key"),t=r.attr("data-value"),o=r.attr("data-action"),a=s(n,t,o);return w(a),!1}),p.on("change",".ajax-style .sort select",function(){var r,n=e(this),t=n.attr("name"),o=n.val();if("srt"===t)if("rel"===o){e(".sort select[name='dir']").hide();var a=window.collex.removeSortFromQueryObject();r="./search?"+window.collex.makeQueryString(a)}else e(".sort select[name='dir']").show();r||(r=s(t,o,"replace")),w(r)}),window.collex.sanitizeString=function(r){if("undefined"==typeof r)return r;for(r=r.replace(/[^0-9A-Za-z\-'"\u00C0-\u017F]/g," ");"'"===r.substr(0,1);)r=r.substr(1);return r=r.replace(/ '/g," "),r=r.replace(/\s+/g," "),e.trim(r)},window.collex.formatYearString=function(e){return e=e.trim().replace(/-/," TO ").replace(/to/i,"TO").replace(/\s+/," "),e=e.replace(/(\b\d{3})\b/g,"0$1"),e=e.replace(/(\b\d{2})\b/g,"00$1"),e=e.replace(/(\b\d{1})\b/g,"000$1"),e=e.trim()},window.collex.sliderRange=function(e,r){var n="y="+e+" TO "+r+"&fuz_q=1&fuz_t=1";n=window.collex.formatYearString(n),w("./search?"+n),t()},p.on("click",".query_add",function(){u(e(this))}),p.on("click",".mod-fuzzy input",function(){var r=e(this),n=this.name,t=r.val(),o=s(n,t,"replace");w(o)}),p.on("change",".query_and-not select",function(){var r=e(this),n=r.val(),t=r.attr("data-key"),o=r.attr("data-val"),a=o;"AND"===n&&"-"===a[0]&&(a=a.substr(1)),"NOT"===n&&"-"!==a[0]&&(a="-"+a);var l=i(t,o,a);w("./search?"+window.collex.makeQueryString(l))}),p.on("keydown",".query.search-form .new-search-term input",function(e){var r=e.which;return 13===r||10===r?!1:void 0}),p.on("keyup",".query.search-form .new-search-term input",function(r){var n=r.which;return 13===n||10===n?(u(e(this)),!1):void 0}),p.on("change",".search_all_federations",function(){if(this.checked){for(var r=[],n=e(".limit_to_federation input"),t=0;t<n.length;t++)r.push(n[t].name);var o=s("f",r,"replace");w(o)}else{var a=window.collex.getUrlVars();delete a.f,delete a.page,w("./search?"+window.collex.makeQueryString(a)),e(".limit_to_federation input").each(function(){e(this).prop("checked",!1)})}}),window.collex.doPageSearch=function(e){var r=window.collex.getUrlVars();r.pages=e,w("./search?"+window.collex.makeQueryString(r))},p.on("change",".limit_to_federation input",function(){var r=e(".limit_to_federation input"),n=!0,t=[];r.each(function(e,r){r.checked&&(n=!1,t.push(r.name))}),t.length<r.length&&e(".search_all_federations").prop("checked",!1);var o=window.collex.getUrlVars();n?delete o.f:o.f=t,delete o.page,w("./search?"+window.collex.makeQueryString(o))}),p.bind("SetSearch",function(e,r){for(var n in r)r.hasOwnProperty(n)&&(r[n]=window.collex.sanitizeString(r[n]));var t=l();jQuery.extend(r,t),w("./search?"+window.collex.makeQueryString(r))}),p.bind("ModifySearch",function(e,r){"y"===r.key&&(r.newValue=window.collex.formatYearString(r.newValue));var n=i(r.key,r.original,window.collex.sanitizeString(r.newValue));w("./search?"+window.collex.makeQueryString(n))}),f()});