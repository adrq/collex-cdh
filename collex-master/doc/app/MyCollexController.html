<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">

<title>class MyCollexController - Rails Application Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>app/controllers/my_collex_controller.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link"><a href="ApplicationController.html">ApplicationController</a>
  
</nav>

    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-i-get_typewright_documents">#get_typewright_documents</a>
    
    <li><a href="#method-i-index">#index</a>
    
    <li><a href="#method-i-remove_profile_picture">#remove_profile_picture</a>
    
    <li><a href="#method-i-results">#results</a>
    
    <li><a href="#method-i-show_profile">#show_profile</a>
    
    <li><a href="#method-i-update_profile">#update_profile</a>
    
    <li><a href="#method-i-update_profile_upload">#update_profile_upload</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="./doc/README_FOR_APP.html">README_FOR_APP</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./Typewright.html">Typewright</a>
  
    <li><a href="./Typewright/AdminController.html">Typewright::AdminController</a>
  
    <li><a href="./Typewright/Document.html">Typewright::Document</a>
  
    <li><a href="./Typewright/DocumentUser.html">Typewright::DocumentUser</a>
  
    <li><a href="./Typewright/DocumentUsersController.html">Typewright::DocumentUsersController</a>
  
    <li><a href="./Typewright/DocumentsController.html">Typewright::DocumentsController</a>
  
    <li><a href="./Typewright/Line.html">Typewright::Line</a>
  
    <li><a href="./Typewright/LinesController.html">Typewright::LinesController</a>
  
    <li><a href="./Typewright/Overview.html">Typewright::Overview</a>
  
    <li><a href="./Typewright/OverviewsController.html">Typewright::OverviewsController</a>
  
    <li><a href="./Typewright/OverviewsHelper.html">Typewright::OverviewsHelper</a>
  
    <li><a href="./Typewright/SoapController.html">Typewright::SoapController</a>
  
    <li><a href="./Typewright/TwFeaturedObject.html">Typewright::TwFeaturedObject</a>
  
    <li><a href="./Typewright/TypewrightHelper.html">Typewright::TypewrightHelper</a>
  
    <li><a href="./Typewright/User.html">Typewright::User</a>
  
    <li><a href="./Admin.html">Admin</a>
  
    <li><a href="./Admin/BaseController.html">Admin::BaseController</a>
  
    <li><a href="./Admin/DefaultController.html">Admin::DefaultController</a>
  
    <li><a href="./Admin/DefaultHelper.html">Admin::DefaultHelper</a>
  
    <li><a href="./Admin/DefaultHelper/Session.html">Admin::DefaultHelper::Session</a>
  
    <li><a href="./Admin/DiscussionTopicsController.html">Admin::DiscussionTopicsController</a>
  
    <li><a href="./Admin/DiscussionTopicsHelper.html">Admin::DiscussionTopicsHelper</a>
  
    <li><a href="./Admin/FeaturesController.html">Admin::FeaturesController</a>
  
    <li><a href="./Admin/FeaturesHelper.html">Admin::FeaturesHelper</a>
  
    <li><a href="./Admin/SetupsController.html">Admin::SetupsController</a>
  
    <li><a href="./Admin/SetupsHelper.html">Admin::SetupsHelper</a>
  
    <li><a href="./Admin/SiteHelper.html">Admin::SiteHelper</a>
  
    <li><a href="./Admin/UserRolesController.html">Admin::UserRolesController</a>
  
    <li><a href="./Admin/UserRolesHelper.html">Admin::UserRolesHelper</a>
  
    <li><a href="./Catalog.html">Catalog</a>
  
    <li><a href="./Catalog/Error.html">Catalog::Error</a>
  
    <li><a href="./GroupsController.html">GroupsController</a>
  
    <li><a href="./GroupsController/RolesUser.html">GroupsController::RolesUser</a>
  
    <li><a href="./ApplicationController.html">ApplicationController</a>
  
    <li><a href="./ApplicationHelper.html">ApplicationHelper</a>
  
    <li><a href="./Branding.html">Branding</a>
  
    <li><a href="./BuilderController.html">BuilderController</a>
  
    <li><a href="./BuilderHelper.html">BuilderHelper</a>
  
    <li><a href="./CachedProperty.html">CachedProperty</a>
  
    <li><a href="./CachedResource.html">CachedResource</a>
  
    <li><a href="./CharSetAlter.html">CharSetAlter</a>
  
    <li><a href="./ClassroomController.html">ClassroomController</a>
  
    <li><a href="./ClassroomHelper.html">ClassroomHelper</a>
  
    <li><a href="./Cluster.html">Cluster</a>
  
    <li><a href="./ClustersController.html">ClustersController</a>
  
    <li><a href="./CollectedItem.html">CollectedItem</a>
  
    <li><a href="./CommentReport.html">CommentReport</a>
  
    <li><a href="./CommunitiesController.html">CommunitiesController</a>
  
    <li><a href="./CommunitiesHelper.html">CommunitiesHelper</a>
  
    <li><a href="./Constraint.html">Constraint</a>
  
    <li><a href="./DiscussionComment.html">DiscussionComment</a>
  
    <li><a href="./DiscussionThread.html">DiscussionThread</a>
  
    <li><a href="./DiscussionThreadsHelper.html">DiscussionThreadsHelper</a>
  
    <li><a href="./DiscussionTopic.html">DiscussionTopic</a>
  
    <li><a href="./DiscussionVisit.html">DiscussionVisit</a>
  
    <li><a href="./DocumentCompleteMailer.html">DocumentCompleteMailer</a>
  
    <li><a href="./Exhibit.html">Exhibit</a>
  
    <li><a href="./ExhibitElement.html">ExhibitElement</a>
  
    <li><a href="./ExhibitElementsController.html">ExhibitElementsController</a>
  
    <li><a href="./ExhibitElementsHelper.html">ExhibitElementsHelper</a>
  
    <li><a href="./ExhibitFootnote.html">ExhibitFootnote</a>
  
    <li><a href="./ExhibitIllustration.html">ExhibitIllustration</a>
  
    <li><a href="./ExhibitIllustrationsController.html">ExhibitIllustrationsController</a>
  
    <li><a href="./ExhibitObject.html">ExhibitObject</a>
  
    <li><a href="./ExhibitPage.html">ExhibitPage</a>
  
    <li><a href="./ExhibitPagesController.html">ExhibitPagesController</a>
  
    <li><a href="./ExhibitsController.html">ExhibitsController</a>
  
    <li><a href="./ExpressionConstraint.html">ExpressionConstraint</a>
  
    <li><a href="./FacetConstraint.html">FacetConstraint</a>
  
    <li><a href="./FeaturedObject.html">FeaturedObject</a>
  
    <li><a href="./FederationConstraint.html">FederationConstraint</a>
  
    <li><a href="./ForumController.html">ForumController</a>
  
    <li><a href="./FreeCultureConstraint.html">FreeCultureConstraint</a>
  
    <li><a href="./FullTextConstraint.html">FullTextConstraint</a>
  
    <li><a href="./GenericMailer.html">GenericMailer</a>
  
    <li><a href="./GetIncludeFileList.html">GetIncludeFileList</a>
  
    <li><a href="./Group.html">Group</a>
  
    <li><a href="./GroupsHelper.html">GroupsHelper</a>
  
    <li><a href="./GroupsUser.html">GroupsUser</a>
  
    <li><a href="./HelpController.html">HelpController</a>
  
    <li><a href="./HomeController.html">HomeController</a>
  
    <li><a href="./HomeHelper.html">HomeHelper</a>
  
    <li><a href="./Image.html">Image</a>
  
    <li><a href="./ImageFull.html">ImageFull</a>
  
    <li><a href="./IsoLanguage.html">IsoLanguage</a>
  
    <li><a href="./LoginController.html">LoginController</a>
  
    <li><a href="./LoginHelper.html">LoginHelper</a>
  
    <li><a href="./LoginInfo.html">LoginInfo</a>
  
    <li><a href="./MyCollexController.html">MyCollexController</a>
  
    <li><a href="./MyCollexHelper.html">MyCollexHelper</a>
  
    <li><a href="./Object.html">Object</a>
  
    <li><a href="./ObjectActivity.html">ObjectActivity</a>
  
    <li><a href="./PeerReview.html">PeerReview</a>
  
    <li><a href="./PublicationImage.html">PublicationImage</a>
  
    <li><a href="./PublicationsController.html">PublicationsController</a>
  
    <li><a href="./PublicationsHelper.html">PublicationsHelper</a>
  
    <li><a href="./ResultsController.html">ResultsController</a>
  
    <li><a href="./Role.html">Role</a>
  
    <li><a href="./SavedSearchConstraint.html">SavedSearchConstraint</a>
  
    <li><a href="./Search.html">Search</a>
  
    <li><a href="./SearchController.html">SearchController</a>
  
    <li><a href="./SearchHelper.html">SearchHelper</a>
  
    <li><a href="./SearchUserContent.html">SearchUserContent</a>
  
    <li><a href="./Session.html">Session</a>
  
    <li><a href="./Setup.html">Setup</a>
  
    <li><a href="./Tag.html">Tag</a>
  
    <li><a href="./TagController.html">TagController</a>
  
    <li><a href="./TagHelper.html">TagHelper</a>
  
    <li><a href="./Tagassign.html">Tagassign</a>
  
    <li><a href="./TestJsController.html">TestJsController</a>
  
    <li><a href="./TestJsHelper.html">TestJsHelper</a>
  
    <li><a href="./TypeWrightConstraint.html">TypeWrightConstraint</a>
  
    <li><a href="./User.html">User</a>
  
    <li><a href="./UsernameAlreadyExistsException.html">UsernameAlreadyExistsException</a>
  
    <li><a href="./VicConference.html">VicConference</a>
  
    <li><a href="./VicConferenceController.html">VicConferenceController</a>
  
    <li><a href="./WebUtils.html">WebUtils</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class MyCollexController</h1>

  <div id="description" class="description">
    
<pre>Copyright 2009 Applied Research in Patacriticism and the University of Virginia

Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</pre>

<p>require ‘json’</p>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    <!-- Methods -->
    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-get_typewright_documents" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_typewright_documents</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_typewright_documents-source">
            <pre><span class="ruby-comment"># File app/controllers/my_collex_controller.rb, line 50</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_typewright_documents</span>
        <span class="ruby-keyword">if</span> <span class="ruby-constant">COLLEX_PLUGINS</span>[<span class="ruby-string">'typewright'</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">user_signed_in?</span>
                <span class="ruby-identifier">my_typewright_documents</span> = <span class="ruby-constant">Typewright</span><span class="ruby-operator">::</span><span class="ruby-constant">DocumentUser</span>.<span class="ruby-identifier">document_list</span>(<span class="ruby-constant">Setup</span>.<span class="ruby-identifier">default_federation</span>(), <span class="ruby-identifier">get_curr_user_id</span>())
                <span class="ruby-identifier">render</span> <span class="ruby-identifier">partial</span><span class="ruby-operator">:</span> <span class="ruby-string">'typewright/widgets/my_documents'</span>, <span class="ruby-value">:locals</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:document_list</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">my_typewright_documents</span>}
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">render</span> <span class="ruby-identifier">text</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;&quot;</span>
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_typewright_documents-source -->
          
        </div>

        

        
      </div><!-- get_typewright_documents-method -->

    
      <div id="method-i-index" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">index</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="index-source">
            <pre><span class="ruby-comment"># File app/controllers/my_collex_controller.rb, line 31</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">index</span>
  <span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">set_cloud_list</span>(<span class="ruby-identifier">user</span>, <span class="ruby-identifier">user</span>.<span class="ruby-identifier">username</span>)

  <span class="ruby-ivar">@results</span> = <span class="ruby-constant">CachedResource</span>.<span class="ruby-identifier">get_newest_collections</span>(<span class="ruby-identifier">user</span>, <span class="ruby-value">5</span>)
  <span class="ruby-identifier">more_results</span> = <span class="ruby-constant">CachedResource</span>.<span class="ruby-identifier">get_newest_collections</span>(<span class="ruby-identifier">user</span>, <span class="ruby-value">6</span>)
  <span class="ruby-ivar">@has_more</span> = <span class="ruby-ivar">@results</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">more_results</span>.<span class="ruby-identifier">length</span>
      <span class="ruby-ivar">@collected</span> = <span class="ruby-identifier">view_context</span>.<span class="ruby-identifier">add_non_solr_info_to_results</span>(<span class="ruby-ivar">@results</span>, <span class="ruby-keyword">nil</span>)

      <span class="ruby-comment"># if COLLEX_PLUGINS['typewright']</span>
      <span class="ruby-comment">#      @my_typewright_documents = Typewright::DocumentUser.document_list(Setup.default_federation(), user.id)</span>
      <span class="ruby-comment"># end</span>

<span class="ruby-keyword">end</span></pre>
          </div><!-- index-source -->
          
        </div>

        

        
      </div><!-- index-method -->

    
      <div id="method-i-remove_profile_picture" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">remove_profile_picture</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="remove_profile_picture-source">
            <pre><span class="ruby-comment"># File app/controllers/my_collex_controller.rb, line 187</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier">remove_profile_picture</span>
<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
<span class="ruby-keyword">if</span> (<span class="ruby-identifier">user</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>)  <span class="ruby-comment"># in case the session times out while the page is displayed. This page expects a user to be logged in.</span>
  <span class="ruby-identifier">render</span> <span class="ruby-value">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;You must be logged in to perform this function. Did your session time out due to inactivity?&quot;</span>, <span class="ruby-value">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:bad_request</span>
  <span class="ruby-keyword">return</span>
<span class="ruby-keyword">end</span>
            <span class="ruby-identifier">user</span>.<span class="ruby-identifier">image</span> = <span class="ruby-keyword">nil</span>
            <span class="ruby-identifier">user</span>.<span class="ruby-identifier">save</span>
<span class="ruby-identifier">redirect_to</span> <span class="ruby-value">:back</span>
    <span class="ruby-keyword">end</span></pre>
          </div><!-- remove_profile_picture-source -->
          
        </div>

        

        
      </div><!-- remove_profile_picture-method -->

    
      <div id="method-i-results" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">results</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="results-source">
            <pre><span class="ruby-comment"># File app/controllers/my_collex_controller.rb, line 59</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">results</span>
  <span class="ruby-comment"># parameters:</span>
  <span class="ruby-comment">#  :view =&gt; 'all_collected', 'untagged', 'tag' (show all collected objects, show all untagged objects, show a single tag)</span>
  <span class="ruby-comment">#  :tag =&gt; 'tag_name' (if :view =&gt; 'tag', then this is the particular tag to show)</span>

  <span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">session</span>[<span class="ruby-value">:tag_zoom</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">1</span>
  <span class="ruby-comment">#do the pagination.</span>
  <span class="ruby-ivar">@page</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">:</span> <span class="ruby-value">1</span>
      <span class="ruby-ivar">@collected_sort_by</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:srt</span>] <span class="ruby-operator">||</span> <span class="ruby-string">''</span>
      <span class="ruby-ivar">@collected_sort_by_direction</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:dir</span>] <span class="ruby-operator">||</span> <span class="ruby-string">'asc'</span>
      <span class="ruby-identifier">items_per_page</span> = <span class="ruby-value">30</span>
  
  <span class="ruby-comment"># we save the view type in the session object in case we are called from a place that shouldn't care which type it is.</span>
  <span class="ruby-comment"># In other words, if we have the param[:view] parameter, we use it and save it. If we don't, then we retrieve it.</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:view</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">session</span>[<span class="ruby-value">:tag_view</span>] = <span class="ruby-identifier">params</span>[<span class="ruby-value">:view</span>]
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">params</span>[<span class="ruby-value">:view</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-value">:tag_view</span>]
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:tag</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">params</span>[<span class="ruby-value">:tag</span>] = <span class="ruby-identifier">params</span>[<span class="ruby-value">:tag</span>].<span class="ruby-identifier">gsub</span>(<span class="ruby-string">&quot;&amp;lt;&quot;</span>,<span class="ruby-string">&quot;&lt;&quot;</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-string">&quot;&amp;gt;&quot;</span>, <span class="ruby-string">&quot;&gt;&quot;</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-string">&quot;&amp;amp;&quot;</span>, <span class="ruby-string">&quot;&amp;&quot;</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-string">&quot;&amp;quot;&quot;</span>, <span class="ruby-string">'&quot;'</span>)
    <span class="ruby-identifier">session</span>[<span class="ruby-value">:tag_current</span>] = <span class="ruby-identifier">params</span>[<span class="ruby-value">:tag</span>]
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">params</span>[<span class="ruby-value">:tag</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-value">:tag_current</span>]
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">set_cloud_list</span>(<span class="ruby-identifier">user</span>, <span class="ruby-identifier">user</span>.<span class="ruby-identifier">username</span>)

              <span class="ruby-identifier">sort_field</span> = <span class="ruby-keyword">nil</span>
              <span class="ruby-keyword">case</span> <span class="ruby-ivar">@collected_sort_by</span>
              <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;&quot;</span> <span class="ruby-keyword">then</span>
                      <span class="ruby-identifier">sort_field</span> = <span class="ruby-string">'date_collected'</span>
              <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;title&quot;</span> <span class="ruby-keyword">then</span>
                      <span class="ruby-identifier">sort_field</span> = <span class="ruby-string">'title'</span>
              <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;author&quot;</span> <span class="ruby-keyword">then</span>
                      <span class="ruby-identifier">sort_field</span> = <span class="ruby-string">'role_AUT'</span>
              <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;year&quot;</span> <span class="ruby-keyword">then</span>
                      <span class="ruby-identifier">sort_field</span> = <span class="ruby-string">'date_label'</span>    <span class="ruby-comment"># note: the 'year' field isn't cached, so we can't sort on that. Should we cache it and refresh all objects?</span>
              <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;a&quot;</span> <span class="ruby-keyword">then</span>
                      <span class="ruby-identifier">sort_field</span> = <span class="ruby-string">'archive'</span>
                      <span class="ruby-keyword">else</span>
                              <span class="ruby-identifier">sort_field</span> = <span class="ruby-string">'date_collected'</span>
              <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># This creates an array of hits. Hits is a hash with these members: uri, text, title[0], archive, date_label[...], url[0], role_*[...], genre[...], source[...], alternative[...], license</span>
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:view</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-string">'all_collected'</span>
    <span class="ruby-identifier">ret</span> = <span class="ruby-constant">CachedResource</span>.<span class="ruby-identifier">get_page_of_hits_by_user</span>(<span class="ruby-identifier">user</span>, <span class="ruby-ivar">@page</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>, <span class="ruby-identifier">items_per_page</span>, <span class="ruby-identifier">sort_field</span>, <span class="ruby-ivar">@collected_sort_by_direction</span>)
    <span class="ruby-ivar">@results</span> = <span class="ruby-identifier">ret</span>[<span class="ruby-value">:results</span>]
    <span class="ruby-ivar">@total_hits</span> = <span class="ruby-identifier">ret</span>[<span class="ruby-value">:total</span>]

    <span class="ruby-keyword">when</span> <span class="ruby-string">'untagged'</span>
    <span class="ruby-identifier">ret</span> = <span class="ruby-constant">CachedResource</span>.<span class="ruby-identifier">get_page_of_all_untagged</span>(<span class="ruby-identifier">user</span>, <span class="ruby-ivar">@page</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>, <span class="ruby-identifier">items_per_page</span>, <span class="ruby-identifier">sort_field</span>, <span class="ruby-ivar">@collected_sort_by_direction</span>)
    <span class="ruby-ivar">@results</span> = <span class="ruby-identifier">ret</span>[<span class="ruby-value">:results</span>]
    <span class="ruby-ivar">@total_hits</span> = <span class="ruby-identifier">ret</span>[<span class="ruby-value">:total</span>]

    <span class="ruby-keyword">when</span> <span class="ruby-string">'tag'</span>
    <span class="ruby-identifier">ret</span> = <span class="ruby-constant">CachedResource</span>.<span class="ruby-identifier">get_page_of_hits_for_tag</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:tag</span>], <span class="ruby-identifier">user</span>, <span class="ruby-ivar">@page</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>, <span class="ruby-identifier">items_per_page</span>, <span class="ruby-identifier">sort_field</span>, <span class="ruby-ivar">@collected_sort_by_direction</span>)
    <span class="ruby-ivar">@results</span> = <span class="ruby-identifier">ret</span>[<span class="ruby-value">:results</span>]
    <span class="ruby-ivar">@total_hits</span> = <span class="ruby-identifier">ret</span>[<span class="ruby-value">:total</span>]

  <span class="ruby-keyword">else</span>
    <span class="ruby-ivar">@results</span> = {}
    <span class="ruby-ivar">@total_hits</span> = <span class="ruby-ivar">@results</span>.<span class="ruby-identifier">length</span>
  <span class="ruby-keyword">end</span>

      <span class="ruby-ivar">@collected</span> = <span class="ruby-identifier">view_context</span>.<span class="ruby-identifier">add_non_solr_info_to_results</span>(<span class="ruby-ivar">@results</span>, <span class="ruby-keyword">nil</span>)
  <span class="ruby-ivar">@num_pages</span> = <span class="ruby-ivar">@total_hits</span>.<span class="ruby-identifier">quo</span>(<span class="ruby-identifier">items_per_page</span>).<span class="ruby-identifier">ceil</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- results-source -->
          
        </div>

        

        
      </div><!-- results-method -->

    
      <div id="method-i-show_profile" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">show_profile</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This is called from AJAX when a user’s link has been clicked.</p>
          

          
          <div class="method-source-code" id="show_profile-source">
            <pre><span class="ruby-comment"># File app/controllers/my_collex_controller.rb, line 149</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">show_profile</span>
        <span class="ruby-identifier">user_id</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:user</span>]
        <span class="ruby-identifier">render</span> <span class="ruby-value">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;/my_collex/profile&quot;</span>, <span class="ruby-value">:locals</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">user_id</span>), <span class="ruby-value">:can_edit</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span> }
<span class="ruby-keyword">end</span></pre>
          </div><!-- show_profile-source -->
          
        </div>

        

        
      </div><!-- show_profile-method -->

    
      <div id="method-i-update_profile" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_profile</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This is called from AJAX when the user has finished filling out the form.</p>
          

          
          <div class="method-source-code" id="update_profile-source">
            <pre><span class="ruby-comment"># File app/controllers/my_collex_controller.rb, line 155</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update_profile</span>
  <span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">user</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>)  <span class="ruby-comment"># in case the session times out while the page is displayed. This page expects a user to be logged in.</span>
    <span class="ruby-identifier">render</span> <span class="ruby-value">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;You must be logged in to perform this function. Did your session time out due to inactivity?&quot;</span>, <span class="ruby-value">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:bad_request</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:account_email</span>] <span class="ruby-operator">!~</span> <span class="ruby-regexp">/\@/</span>
    <span class="ruby-identifier">render</span> <span class="ruby-value">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;An e-mail address is required&quot;</span>, <span class="ruby-value">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:bad_request</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:account_password</span>] <span class="ruby-operator">!=</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:account_password2</span>]
    <span class="ruby-identifier">render</span> <span class="ruby-value">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;Passwords do not match&quot;</span>, <span class="ruby-value">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:bad_request</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">user</span>.<span class="ruby-identifier">institution</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">'institution'</span>]
  <span class="ruby-identifier">user</span>.<span class="ruby-identifier">fullname</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">'fullname'</span>]
  <span class="ruby-identifier">user</span>.<span class="ruby-identifier">email</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">'account_email'</span>]
  <span class="ruby-identifier">user</span>.<span class="ruby-identifier">hide_email</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">'hide_email'</span>]
  <span class="ruby-identifier">user</span>.<span class="ruby-identifier">link</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">'link'</span>]
  <span class="ruby-identifier">user</span>.<span class="ruby-identifier">about_me</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">'aboutme'</span>]
  <span class="ruby-comment">#check the link for a javascript attack</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">link</span>.<span class="ruby-identifier">downcase</span>.<span class="ruby-identifier">index</span>(<span class="ruby-string">&quot;javascript:&quot;</span>) <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">user</span>.<span class="ruby-identifier">link</span> = <span class="ruby-string">&quot;invalid link entered&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">user</span>.<span class="ruby-identifier">save</span>

  <span class="ruby-constant">User</span>.<span class="ruby-identifier">update_user</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">username</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:account_password</span>].<span class="ruby-identifier">strip</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:account_email</span>])

  <span class="ruby-identifier">render</span> <span class="ruby-value">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'profile'</span>, <span class="ruby-value">:locals</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">user</span>, <span class="ruby-value">:can_edit</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span> }
<span class="ruby-keyword">end</span></pre>
          </div><!-- update_profile-source -->
          
        </div>

        

        
      </div><!-- update_profile-method -->

    
      <div id="method-i-update_profile_upload" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_profile_upload</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>The file upload is done in a separate call because of ajax limitations.</p>
          

          
          <div class="method-source-code" id="update_profile_upload-source">
            <pre><span class="ruby-comment"># File app/controllers/my_collex_controller.rb, line 199</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">update_profile_upload</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
                <span class="ruby-identifier">flash</span> = <span class="ruby-string">''</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>       <span class="ruby-comment"># If the session expired while the dlg was on the page, don't go further.</span>
                        <span class="ruby-keyword">if</span>  <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-string">'image'</span>].<span class="ruby-identifier">blank?</span>
                                <span class="ruby-identifier">err</span> = <span class="ruby-constant">Image</span>.<span class="ruby-identifier">save_image</span>(<span class="ruby-identifier">params</span>[<span class="ruby-string">'image'</span>], <span class="ruby-identifier">user</span>)
                                <span class="ruby-keyword">if</span> <span class="ruby-identifier">err</span>[<span class="ruby-value">:status</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:error</span>
                                        <span class="ruby-identifier">flash</span> = <span class="ruby-identifier">err</span>[<span class="ruby-value">:user_error</span>]
                                        <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">error</span>(<span class="ruby-identifier">err</span>[<span class="ruby-value">:log_error</span>])
                                <span class="ruby-keyword">end</span>
                        <span class="ruby-keyword">end</span>
<span class="ruby-comment">#                       if params['image'] &amp;&amp; params['image'].original_filename.length &gt; 0</span>
<span class="ruby-comment">#                               begin</span>
<span class="ruby-comment">#                                       img = Image.new</span>
<span class="ruby-comment">#                                       img.photo = params['image']</span>
<span class="ruby-comment">#                                       img.save</span>
<span class="ruby-comment">#                                       user.image_id = img.id</span>
<span class="ruby-comment">#                                       user.save</span>
<span class="ruby-comment">#                               rescue Exception =&gt; msg</span>
<span class="ruby-comment">#                                       flash = &quot;ERROR: The image you have uploaded is too large or of the wrong type.&lt;br /&gt;The file name must end in .jpg, .png or .gif, and cannot exceed 1MB in size.&quot;</span>
<span class="ruby-comment">#                                       logger.error(&quot;**** ERROR: Uploading profile picture: &quot; + msg)</span>
<span class="ruby-comment">#                               end</span>
<span class="ruby-comment">#                       end</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">flash</span> = <span class="ruby-string">&quot;Your session has expired. Please refresh this page and log in again.&quot;</span>
                <span class="ruby-keyword">end</span>
<span class="ruby-comment">#    old_image = nil</span>
<span class="ruby-comment">#    if params['image'] != nil &amp;&amp; params['image'].length &gt; 0</span>
<span class="ruby-comment">#      old_image = user.image_id</span>
<span class="ruby-comment">#      user.image = Image.new({ :uploaded_data =&gt; params['image'] })</span>
<span class="ruby-comment">#      user.image.save!</span>
<span class="ruby-comment">#    end</span>

      <span class="ruby-comment"># now we need to figure out what happened with the attachment.</span>
      <span class="ruby-comment"># If there was an error image_id is set to nil, and we want to reset it to the previous image.</span>
      <span class="ruby-comment"># If there was no error, and there was a previous image, then we want to delete the previous one from the file system.</span>
<span class="ruby-comment">#      if old_image != nil</span>
<span class="ruby-comment">#        if user.image_id == nil</span>
<span class="ruby-comment">#          user.image = nil</span>
<span class="ruby-comment">#          user.update_attribute(:image_id, old_image) </span>
<span class="ruby-comment">#        else</span>
<span class="ruby-comment">#          id = old_image.to_s.rjust(4, '0')</span>
<span class="ruby-comment">#          folder = &quot;#{Rails.root}/public/uploads/0000/#{id}/&quot;</span>
<span class="ruby-comment">#          d = Dir.new(folder)</span>
<span class="ruby-comment">#          d.each {|f|</span>
<span class="ruby-comment">#            if f != '.' &amp;&amp; f != '..'</span>
<span class="ruby-comment">#              File.delete(folder + f)</span>
<span class="ruby-comment">#            end</span>
<span class="ruby-comment">#          }</span>
<span class="ruby-comment">#          Dir.delete(folder)</span>
<span class="ruby-comment">#        end</span>
<span class="ruby-comment">#      end</span>
    <span class="ruby-comment">#      if params['image'].length &gt; 0</span>
    <span class="ruby-comment">#        folder = &quot;#{Rails.root}/public/images/users/&quot;</span>
    <span class="ruby-comment">#        image_path = &quot;#{folder}#{user.id}&quot;</span>
    <span class="ruby-comment">#        Dir.mkdir(folder) unless File.exists?(folder)</span>
    <span class="ruby-comment">#        File.open(image_path, &quot;wb&quot;) { |f| f.write(params['image'].read) }</span>
    <span class="ruby-comment">#      end</span>
    <span class="ruby-identifier">render</span> <span class="ruby-value">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">respond_to_file_upload</span>(<span class="ruby-string">&quot;stopUpload&quot;</span>, <span class="ruby-identifier">flash</span>)  <span class="ruby-comment"># This is loaded in the iframe and tells the dialog that the upload is complete.</span>
  <span class="ruby-keyword">end</span></pre>
          </div><!-- update_profile_upload-source -->
          
        </div>

        

        
      </div><!-- update_profile_upload-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.2.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

